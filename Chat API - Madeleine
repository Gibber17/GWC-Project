# Chat backend
# Stores messages in XML, lets us get and save chats

import xml.etree.ElementTree as ET
from pathlib import Path
import time
from XmlCreator import XmlCreator
from ChatBot import ChatBot

class ChatBackend:
    def __init__(self):
        self.chat_file = Path("Contacts.xml")
        self.make_sure_file_exists()  # ensure file exists

    def saveMessage(self, contact_name, text):
        xml_creator = XmlCreator("Contacts.xml")

        # --- Load or create <contact> element ---
        root = xml_creator.root
        contact = root.find(f"./contact[name='{contact_name}']")

        if contact is None:
            # Create new contact
            contact = ET.SubElement(root, "contact")
            name_el = ET.SubElement(contact, "name")
            name_el.text = contact_name

            messages_el = ET.SubElement(contact, "messages")
        else:
            # Contact exists â†’ find <messages>
            messages_el = contact.find("messages")
            if messages_el is None:
                messages_el = ET.SubElement(contact, "messages")

        # --- Add new <message> element ---
        xml_creator.add_element(messages_el, "message", text=text)

        xml_creator.write_to_xml("Contacts.xml")
        print("saved message:", text)

    def bot_reply(self, contact, text):
        user_text = text.lower()
        ts = int(time.time())

        bot = ChatBot()
        bot.sendMessage(user_text)
        bot_msg = ET.SubElement(contact, "message", {"sender": "Bot", "ts": str(ts)})
