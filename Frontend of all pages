import tkinter as tk
from tkinter import ttk
from datetime import datetime
from ChatBot import ChatBot

# ================= CHAT PAGE ===================
class ChatBubbleApp(tk.Frame):
    def __init__(self, parent, controller, bot_name="French Bot", color="#2318f0"):
        super().__init__(parent)
        self.controller = controller
        self.bot_name = bot_name
        self.color = color

        # Get bot theme
        self.theme = self.controller.bot_settings.get(bot_name, {}).get("theme", "Light Mode")

        # Set colors based on theme
        self.apply_theme(self.theme)

        # ==== Top bar ====
        top_frame = tk.Frame(self, bg=self.bg_color)
        top_frame.pack(fill="x", side="top", pady=5, padx=10)

        back_button = tk.Button(
            top_frame, text="‚Üê", bg=self.bg_color, fg=self.fg_color,
            font=("Segoe UI", 14, "bold"), relief="flat", bd=0,
            command=self.go_back
        )
        back_button.pack(side="left")

        self.title_label = tk.Label(
            top_frame, text=f"üí¨ {self.bot_name}", bg=self.bg_color,
            fg=self.fg_color, font=("Segoe UI", 12, "bold")
        )
        self.title_label.pack(side="left", anchor="w", padx=10)

        settings_button = tk.Button(
            top_frame, text="‚öô", bg=self.bg_color, fg=self.fg_color,
            font=("Segoe UI", 14, "bold"), relief="flat", bd=0,
            command=self.open_settings
        )
        settings_button.pack(side="right", anchor="e")

        # ==== Chat frame ====
        chat_frame = tk.Frame(self, bg=self.bg_color)
        chat_frame.pack(fill="both", expand=True)

        # Style the scrollbar
        style = ttk.Style()
        style.theme_use('clam')
        style.configure("Vertical.TScrollbar", 
                       background="#CCCCCC",  # Gray by default
                       troughcolor=self.bg_color,
                       bordercolor=self.bg_color,
                       arrowcolor="white",
                       width=8)  # Smaller width
        style.map("Vertical.TScrollbar",
                 background=[('active', '#4A90E2')])  # Blue on hover

        self.chat_canvas = tk.Canvas(chat_frame, bg=self.bg_color, bd=0, highlightthickness=0)
        scrollbar = ttk.Scrollbar(chat_frame, orient="vertical", command=self.chat_canvas.yview, style="Vertical.TScrollbar")
        self.scrollable_frame = tk.Frame(self.chat_canvas, bg=self.bg_color)

        self.scrollable_frame.bind(
            "<Configure>",
            lambda e: self.chat_canvas.configure(scrollregion=self.chat_canvas.bbox("all"))
        )

        self.chat_canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw")
        self.chat_canvas.configure(yscrollcommand=scrollbar.set)
        self.chat_canvas.pack(side="left", fill="both", expand=True, padx=(10, 0), pady=(10, 0))
        scrollbar.pack(side="right", fill="y", padx=(0, 10))

        # Enable mouse wheel scrolling
        self.chat_canvas.bind_all("<MouseWheel>", self._on_mousewheel)

        # ==== Entry ====
        entry_frame = tk.Frame(self, bg=self.bg_color)
        entry_frame.pack(fill="x", side="bottom", padx=10, pady=10)

        self.entry = tk.Entry(entry_frame, font=("Segoe UI", 11), bg=self.entry_bg, fg=self.entry_fg)
        self.entry.pack(side="left", fill="x", expand=True, padx=(0, 8))
        self.entry.bind("<Return>", self.send_message)

        send_button = tk.Button(
            entry_frame, text="Send", command=self.send_message,
            bg="#5CB85C", fg="white", font=("Segoe UI", 10, "bold"),
            relief="flat", padx=10, pady=5
        )
        send_button.pack(side="right")

        # Load conversation history if it exists
        self.load_conversation_history()

    def load_conversation_history(self):
        """Load previous conversation messages for this bot"""
        if self.bot_name in self.controller.conversation_history:
            for msg_data in self.controller.conversation_history[self.bot_name]:
                self.add_message(msg_data["name"], msg_data["message"], sender=msg_data["sender"], save_to_history=False)
        else:
            # Welcome message for new conversation
            self.add_message("System", f"Welcome to {self.bot_name}!", sender="bot")
            # Initialize history for this bot
            self.controller.conversation_history[self.bot_name] = []

    def _on_mousewheel(self, event):
        self.chat_canvas.yview_scroll(int(-1*(event.delta/120)), "units")

    def apply_theme(self, theme_name):
        if theme_name == "Dark Mode":
            self.bg_color = "#2c2f33"
            self.fg_color = "#ffffff"
            self.user_bubble_color = "#4A90E2"  # keep blue
            self.bot_bubble_color = "#5CB85C"   # keep green
            self.text_color = "#FFFFFF"         # white text
            self.entry_bg = "#23272a"
            self.entry_fg = "#ffffff"
        else:  # Light Mode
            self.bg_color = "#FFFFFF"          # white background
            self.fg_color = "#000000"
            self.user_bubble_color = "#4A90E2"  # blue chat bubbles
            self.bot_bubble_color = "#5CB85C"   # green bot bubbles
            self.text_color = "#FFFFFF"         # white text on colored bubbles
            self.entry_bg = "white"
            self.entry_fg = "black"

    def go_back(self):
        # Contacts page always stays in light mode
        self.controller.show_frame("ContactsPage")

    def add_message(self, name, message, sender="user", save_to_history=True):
        bubble_frame = tk.Frame(self.scrollable_frame, bg=self.bg_color)
        if sender == "user":
            bubble_color = self.user_bubble_color
            anchor, justify, padx = "e", "left", (100, 0)
        else:
            bubble_color = self.bot_bubble_color
            anchor, justify, padx = "w", "left", (0, 100)

        label = tk.Label(
            bubble_frame, text=message, bg=bubble_color, fg=self.text_color,
            font=("Segoe UI", 11), wraplength=300, justify=justify, anchor="w",
            padx=10, pady=6, bd=1, relief="solid",
        )
        label.pack(padx=padx, pady=(4, 0), anchor=anchor, ipadx=5, ipady=2)

        timestamp = datetime.now().strftime("%I:%M %p")
        time_label = tk.Label(
            bubble_frame, text=timestamp, bg=self.bg_color, fg="#666666",
            font=("Segoe UI", 8, "italic"), justify=justify
        )
        time_label.pack(anchor=anchor, padx=padx, pady=(0, 6))

        bubble_frame.pack(fill="x", pady=2)
        self.after(100, lambda: self.chat_canvas.yview_moveto(1))
        
        # Save to conversation history
        if save_to_history:
            if self.bot_name not in self.controller.conversation_history:
                self.controller.conversation_history[self.bot_name] = []
            self.controller.conversation_history[self.bot_name].append({
                "name": name,
                "message": message,
                "sender": sender
            })

    def send_message(self, event=None):
        msg = self.entry.get().strip()
        if not msg:
            return

        # Add user message to UI
        self.add_message("You", msg, sender="user")
        self.entry.delete(0, tk.END)

        # After delay, add bot reply
        self.after(600, lambda: self.add_message(
            self.bot_name,
            self.bot_reply(msg),  # <-- bot_reply now returns a string
            sender="bot"
        ))

    def bot_reply(self, msg):
        bot = ChatBot()
        reply = bot.sendMessage(msg)
        return reply


    def open_settings(self):
        settings_page_name = f"{self.bot_name}SettingsPage"
        if settings_page_name not in self.controller.frames:
            settings_page = LanguageBotSettingsPage(
                self.controller.container,
                self.controller,
                bot_name=self.bot_name
            )
            self.controller.frames[settings_page_name] = settings_page
            settings_page.place(x=0, y=0, relwidth=1, relheight=1)
        self.controller.show_frame(settings_page_name)


# ================= LANGUAGE BOT SETTINGS ===================
class LanguageBotSettingsPage(tk.Frame):
    def __init__(self, parent, controller, bot_name="Bot"):
        super().__init__(parent)
        self.controller = controller
        self.bot_name = bot_name
        self.configure(bg="#FFFFFF")

        # Header
        header_frame = tk.Frame(self, bg="#FFFFFF")
        header_frame.pack(pady=20)
        tk.Label(
            header_frame,
            text=f"‚öô {self.bot_name} Settings",
            font=("Helvetica", 18, "bold"),
            bg="#FFFFFF",
            fg="#4A90E2"
        ).pack()

        # Theme Button
        current_theme = self.controller.bot_settings[self.bot_name]["theme"]
        self.theme_btn = ttk.Button(
            self,
            text=f"üé® Theme: {current_theme}",
            command=self.open_theme_page
        )
        self.theme_btn.pack(pady=20, ipadx=10, ipady=5)

        # Difficulty Button
        current_diff = self.controller.bot_settings[self.bot_name]["difficulty"]
        self.diff_btn = ttk.Button(
            self,
            text=f"üìä Difficulty: {current_diff}",
            command=self.open_difficulty_page
        )
        self.diff_btn.pack(pady=10, ipadx=10, ipady=5)

        # Back button
        back_btn = ttk.Button(self, text="‚Üê Back to Chat", command=self.go_back)
        back_btn.pack(pady=30)

    def open_theme_page(self):
        ThemePage(self, bot_name=self.bot_name)

    def open_difficulty_page(self):
        DifficultyPage(self, bot_name=self.bot_name)

    def go_back(self):
        self.controller.show_frame("ChatBubbleApp")


# ================= THEME & DIFFICULTY PAGES ===================
class ThemePage(tk.Toplevel):
    def __init__(self, parent, bot_name):
        super().__init__(parent)
        self.title("Theme Settings")
        self.geometry("400x400")
        self.configure(bg="#FFFFFF")
        self.parent = parent
        self.bot_name = bot_name

        tk.Label(self, text="Choose a Theme", font=("Helvetica", 18, "bold"), bg="#FFFFFF", fg="#4A90E2").pack(pady=30)
        ttk.Button(self, text="Light Mode", command=lambda: self.set_theme("Light Mode")).pack(pady=10)
        ttk.Button(self, text="Dark Mode", command=lambda: self.set_theme("Dark Mode")).pack(pady=10)
        ttk.Button(self, text="Back", command=self.go_back).pack(pady=30)

    def set_theme(self, theme_name):
        self.parent.controller.bot_settings[self.bot_name]["theme"] = theme_name
        self.parent.theme_btn.config(text=f"üé® Theme: {theme_name}")

        # Apply theme to chat immediately
        chat_frame = self.parent.controller.frames.get("ChatBubbleApp")
        if chat_frame and chat_frame.bot_name == self.bot_name:
            chat_frame.theme = theme_name
            chat_frame.apply_theme(theme_name)
            
            # Update all UI elements
            chat_frame.configure(bg=chat_frame.bg_color)
            chat_frame.chat_canvas.configure(bg=chat_frame.bg_color)
            chat_frame.scrollable_frame.configure(bg=chat_frame.bg_color)
            chat_frame.entry.configure(bg=chat_frame.entry_bg, fg=chat_frame.entry_fg)
            
            # Update top bar elements
            for widget in chat_frame.winfo_children():
                if isinstance(widget, tk.Frame):
                    widget.configure(bg=chat_frame.bg_color)
                    for child in widget.winfo_children():
                        if isinstance(child, (tk.Label, tk.Button)):
                            child.configure(bg=chat_frame.bg_color, fg=chat_frame.fg_color)
            
            # Update all existing message bubbles
            for widget in chat_frame.scrollable_frame.winfo_children():
                widget.configure(bg=chat_frame.bg_color)
                for child in widget.winfo_children():
                    if isinstance(child, tk.Label):
                        # Check if it's a message bubble or timestamp
                        if child.cget("relief") == "solid":  # Message bubble
                            # Keep the bubble background colors (user=blue, bot=green)
                            # Just update the background frame, not the bubble colors
                            pass
                        else:  # Timestamp
                            child.configure(bg=chat_frame.bg_color)
        self.go_back()

    def go_back(self):
        self.destroy()


class DifficultyPage(tk.Toplevel):
    def __init__(self, parent, bot_name):
        super().__init__(parent)
        self.title("Difficulty Settings")
        self.geometry("400x400")
        self.configure(bg="#FFFFFF")
        self.parent = parent
        self.bot_name = bot_name

        tk.Label(self, text="Select Difficulty", font=("Helvetica", 18, "bold"), bg="#FFFFFF", fg="#5CB85C").pack(pady=30)
        ttk.Button(self, text="Beginner - A1", command=lambda: self.set_difficulty("Beginner - A1")).pack(pady=10)
        ttk.Button(self, text="Intermediate - B1", command=lambda: self.set_difficulty("Intermediate - B1")).pack(pady=10)
        ttk.Button(self, text="Advanced - C1", command=lambda: self.set_difficulty("Advanced - C1")).pack(pady=10)
        ttk.Button(self, text="Back", command=self.go_back).pack(pady=30)

    def set_difficulty(self, level):
        self.parent.controller.bot_settings[self.bot_name]["difficulty"] = level
        self.parent.diff_btn.config(text=f"üìä Difficulty: {level}")
        self.go_back()

    def go_back(self):
        self.destroy()


# ================= CONTACTS PAGE ===================
class ContactsPage(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent)
        self.controller = controller
        self.configure(bg="#FFFFFF")
        
        # Track contacts
        self.contacts = []

        # Header
        header = tk.Frame(self, bg="#4A90E2", height=50)
        header.pack(fill="x")

        title = tk.Label(header, text="Contacts", bg="#4A90E2", fg="white",
                         font=("Arial", 16, "bold"))
        title.pack(side="left", padx=15, pady=10)

        add_btn = tk.Button(header, text="+", bg="white", fg="#4A90E2",
                            font=("Arial", 18, "bold"), borderwidth=0,
                            command=self.prompt_add_contact)
        add_btn.pack(side="right", padx=15)

        # Contacts list starts empty
    
    def prompt_add_contact(self):
        from tkinter import messagebox, simpledialog
        
        # Ask if they want to add a contact
        result = messagebox.askyesno("Add Contact", "Would you like to add a new contact?")
        
        if result:
            # Ask what language
            language = simpledialog.askstring("Language", "What language would you like to learn?")
            
            if language:
                language = language.strip().capitalize()
                bot_name = f"{language} Bot"
                
                # Check if already exists
                if bot_name in self.contacts:
                    messagebox.showinfo("Already Added", f"{bot_name} is already in your contacts!")
                    return
                
                # Define colors for different languages
                language_colors = {
                    "French": "#2318f0",
                    "Spanish": "#e82217",
                    "German": "#f2d202",
                    "Italian": "#009246",
                    "Portuguese": "#006600",
                    "Chinese": "#DE2910",
                    "Japanese": "#BC002D",
                    "Korean": "#003478",
                }
                
                # Get color for language or use default blue
                color = language_colors.get(language, "#4A90E2")
                
                # Get initials (first 2 letters)
                initials = language[:2].upper()
                
                # Calculate position
                y_position = 70 + len(self.contacts) * 80
                
                # Add to bot_settings if not exists
                if bot_name not in self.controller.bot_settings:
                    self.controller.bot_settings[bot_name] = {
                        "theme": "Light Mode",
                        "difficulty": "Beginner - A1"
                    }
                
                # Add the contact
                self.add_contact(y_position, bot_name, initials, 0, color)
                self.contacts.append(bot_name)

    def add_contact(self, y, name, initials, progress, color="#4A90E2"):
        frame = tk.Frame(self, bg="white")
        frame.place(x=10, y=y, width=300, height=70)

        icon_canvas = tk.Canvas(frame, width=40, height=40, bg="white", highlightthickness=0)
        icon_canvas.place(x=10, y=15)
        icon_canvas.create_oval(0, 0, 40, 40, fill=color, outline=color)
        icon_canvas.create_text(20, 20, text=initials, fill="white", font=("Arial", 12, "bold"))

        name_label = tk.Label(frame, text=name, bg="white", fg="black", font=("Arial", 12, "bold"))
        name_label.place(x=60, y=10)

        style = ttk.Style()
        style.configure(f"{name}.Horizontal.TProgressbar", troughcolor="white", background="green")
        progress_bar = ttk.Progressbar(frame, style=f"{name}.Horizontal.TProgressbar", length=220, value=progress)
        progress_bar.place(x=60, y=40)

        for widget in [frame, icon_canvas, name_label, progress_bar]:
            widget.bind("<Button-1>", lambda e, n=name, c=color: self.controller.open_chat(n, c))


# ================= MAIN APP ===================
class LanguageApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Contacts")
        self.geometry("330x520")
        self.resizable(True, True)

        self.container = tk.Frame(self)
        self.container.pack(fill="both", expand=True)

        # Bot settings stored per bot
        self.bot_settings = {
            "French Bot": {"theme": "Light Mode", "difficulty": "Beginner - A1"},
            "Spanish Bot": {"theme": "Light Mode", "difficulty": "Beginner - A1"},
            "German Bot": {"theme": "Light Mode", "difficulty": "Beginner - A1"},
        }
        
        # Store conversation history for each bot
        self.conversation_history = {}

        self.frames = {}
        contacts_page = ContactsPage(self.container, self)
        self.frames["ContactsPage"] = contacts_page
        contacts_page.place(x=0, y=0, relwidth=1, relheight=1)

        self.show_frame("ContactsPage")

    def show_frame(self, page_name):
        self.frames[page_name].tkraise()

    def open_chat(self, bot_name, color):
        chat_page = ChatBubbleApp(self.container, self, bot_name, color)
        self.frames["ChatBubbleApp"] = chat_page
        chat_page.place(x=0, y=0, relwidth=1, relheight=1)
        self.show_frame("ChatBubbleApp")


if __name__ == "__main__":
    app = LanguageApp()
    app.mainloop()
